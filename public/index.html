<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBD Quiz Game</title>
    <link rel="stylesheet" href="css/style.css">


    <link rel="icon" href="https://bbdsoftware.com/wp-content/uploads/cropped-favicon-150x150.png" sizes="32x32">
    <link rel="icon" href="https://bbdsoftware.com/wp-content/uploads/cropped-favicon-300x300.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://bbdsoftware.com/wp-content/uploads/cropped-favicon-300x300.png">
</head>

<body class="container">

    <header>
        <img src="./images/logo2.svg" alt="logo">
        <h1 id="name-heading"> Welcome to the <br /> BBD Quiz Game</h1>
    </header>
    <br /><br />
    <main>
        <p>Please complete the form below to take part in a quiz</p>

        <form id="detail-capture" onsubmit="registerToTakePart">
            <div class="floating-label-wrap mb">
                <input type="text" class="floating-label-field floating-label-field--s3" id="first-name"
                    name="first-name" placeholder="E.g. John" required>
                <label for="first-name" class="floating-label">First Name</label>
            </div>
            <div class="floating-label-wrap mb2">
                <input type="text" class="floating-label-field floating-label-field--s3" id="last-name" name="last-name"
                    placeholder="E.g. Doe" required>
                <label for="last-name" class="floating-label">Surname</label>
            </div>
            <div class="floating-label-wrap mb">
                <input type="text" class="floating-label-field floating-label-field--s3" id="degree" name="degree"
                    placeholder="E.g. BSc Computer Science" required>
                <label for="degree" class="floating-label">Current Degree / Program</label>
            </div>
            <div class="floating-label-wrap mb2">
                <input type="text" class="floating-label-field floating-label-field--s3" id="year" name="year"
                    placeholder="E.g. 2nd Year" required>
                <label for="year" class="floating-label">Current Year of Study</label>
            </div>
            <div class="floating-label-wrap mb">
                <input type="email" class="floating-label-field floating-label-field--s3" id="email" name="email"
                    placeholder="E.g. john.doe@gmail.com" required>
                <label for="email" class="floating-label">Email Address</label>
            </div>
            <div class="floating-label-wrap mb2">
                <input type="tel" class="floating-label-field floating-label-field--s3" id="phone" name="phone"
                    placeholder="E.g. 0821234567" required>
                <label for="phone" class="floating-label">Phone Number</label>
            </div>
            <label class="form-control mb2" id="consent-container">
                <input type="checkbox" name="checkbox" id="consent" />
                <span><strong>I understand and agree:</strong> By checking this box, I hereby grant consent to BBD to collect and store the details provided above. I understand and acknowledge that BBD may use these details to contact me in the future. I am aware that I have the right to withdraw this consent at any time by contacting BBD.</span>
            </label>

            <!-- <p id="error-message"></p> -->

            <section class="btns" style="display: flex; align-items: center; justify-content: start;">
                <input type="reset" class="btn" value="Clear" style="background: none; border: solid 1px;">
                <button type="button" class="btn" onclick="registerToTakePart()" style="width: 100%;">Register</button>
            </section>
        </form>

        <br />

    </main>

    <script src="js/index.js" type="module"></script>

    <script>

        if (localStorage.getItem("alreadyRegistered") == "true") {
            document.getElementById("first-name").value = localStorage.getItem("firstName");
            document.getElementById("last-name").value = localStorage.getItem("lastName");
            document.getElementById("degree").value = localStorage.getItem("degree");
            document.getElementById("year").value = localStorage.getItem("year");
            document.getElementById("email").value = localStorage.getItem("email");
            document.getElementById("phone").value = localStorage.getItem("phone");
            document.getElementById("consent").checked = localStorage.getItem("consent");
        }

        async function registerToTakePart() {
            let firstName = document.getElementById("first-name").value;
            let lastName = document.getElementById("last-name").value;
            let degree = document.getElementById("degree").value;
            let year = document.getElementById("year").value;
            let email = document.getElementById("email").value;
            let phone = document.getElementById("phone").value;
            let consent = document.getElementById("consent").checked;

            let valid = true;

            if (!consent) {
                // document.getElementById("error-message").textContent = "Please agree to the terms and conditions";
                document.getElementById("consent-container").style.border = "solid 1px red";
                valid = false;
            } else {
                // document.getElementById("error-message").textContent = "";
                document.getElementById("consent-container").style.border = "none";
            }

            if (firstName == "") {
                document.getElementById("first-name").style.borderColor = "red";
                valid = false;
            } else {
                document.getElementById("first-name").style.borderColor = "rgba(255, 255, 255, 0.1)";
            }
            if (lastName == "") {
                document.getElementById("last-name").style.borderColor = "red";
                valid = false;
            } else {
                document.getElementById("last-name").style.borderColor = "rgba(255, 255, 255, 0.1)";
            }
            if (degree == "") {
                document.getElementById("degree").style.borderColor = "red";
                valid = false;
            } else {
                document.getElementById("degree").style.borderColor = "rgba(255, 255, 255, 0.1)";
            }
            if (year == "") {
                document.getElementById("year").style.borderColor = "red";
                valid = false;
            } else {
                document.getElementById("year").style.borderColor = "rgba(255, 255, 255, 0.1)";
            }
            if (email == "") {
                document.getElementById("email").style.borderColor = "red";
                valid = false;
            } else {
                document.getElementById("email").style.borderColor = "rgba(255, 255, 255, 0.1)";
            }
            if (phone == "") {
                document.getElementById("phone").style.borderColor = "red";
                valid = false;
            } else {
                document.getElementById("phone").style.borderColor = "rgba(255, 255, 255, 0.1)";
            }

            if (valid) {
                localStorage.setItem("firstName", firstName);
                localStorage.setItem("lastName", lastName);
                localStorage.setItem("degree", degree);
                localStorage.setItem("year", year);
                localStorage.setItem("email", email);
                localStorage.setItem("phone", phone);
                localStorage.setItem("consent", consent);
                
                
                const user = {
                    firstName : firstName,
                    surname : lastName,
                    degree : degree,
                    year : year,
                    email : email,
                    phone : phone,
                    consent : consent
                }

                let result = await fetch("/game/user/register", {
                    method: "POST",
                    headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                });

                result = await result.json();

                if(result.result == "success"){
                    localStorage.setItem("alreadyRegistered", true);
                    localStorage.setItem("id", result.id);

                    // get url param "join"
                    let urlParams = new URLSearchParams(window.location.search);
                    let joinCode = urlParams.get('join');

                    // check if join is set
                    if (joinCode != null) {
                        window.location = "/home/game/?join=" + joinCode;
                    } else{
                        window.location = "/home";
                    }
                } else {
                    console.log("Error registering...");
                    console.log(result);
                }
            }
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
            .replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0, 
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    </script>
</body>

</html>